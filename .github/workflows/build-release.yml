name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # 触发条件：推送版本标签，如 v1.0.0
  workflow_dispatch:  # 允许手动触发

env:
  APP_NAME: SubtitleEditApp

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-13
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.*'
        host: 'mac'
        target: 'desktop'
        arch: 'clang_64'
        cache: true
    
    - name: Check Qt encoding support
      run: |
        # 创建测试程序检查编码支持
        cat > test_encodings.cpp << 'EOF'
        #include <QCoreApplication>
        #include <QStringConverter>
        #include <QDebug>
        #include <iostream>
        
        int main() {
            auto codecs = QStringConverter::availableCodecs();
            std::cout << "=== Available Codecs ===" << std::endl;
            bool hasGBK = false;
            bool hasSystem = false;
            
            for (const auto &codec : codecs) {
                std::cout << codec.toStdString() << std::endl;
                if (codec.contains("GBK", Qt::CaseInsensitive) || 
                    codec.contains("936", Qt::CaseInsensitive)) {
                    hasGBK = true;
                    std::cout << "*** GBK SUPPORT FOUND: " << codec.toStdString() << " ***" << std::endl;
                }
                if (codec.contains("System", Qt::CaseInsensitive)) {
                    hasSystem = true;
                    std::cout << "*** System SUPPORT FOUND: " << codec.toStdString() << " ***" << std::endl;
                }
            }
            
            std::cout << std::endl;
            std::cout << "GBK Support: " << (hasGBK ? "YES" : "NO") << std::endl;
            std::cout << "System Support: " << (hasSystem ? "YES" : "NO") << std::endl;
            
            return 0;
        }
        EOF
        
        # 编译并运行测试
        qmake -project "CONFIG += console"
        qmake CONFIG+=release
        make
        ./test_encodings
    
    - name: Install GNU libiconv for GBK support
      run: |
        brew install libiconv
        echo "LIBICONV_PATH=$(brew --prefix libiconv)" >> $GITHUB_ENV
    
    - name: Make package script executable
      run: chmod +x package_macos.sh
    
    - name: Build and package using local script
      run: |
        # Build and package
        ./package_macos.sh
        
        # Copy libiconv to app bundle for GBK support
        if [ -f "${LIBICONV_PATH}/lib/libiconv.dylib" ]; then
          echo "Copying libiconv to app bundle..."
          cp "${LIBICONV_PATH}/lib/libiconv.dylib" build/${{ env.APP_NAME }}.app/Contents/Frameworks/
          
          # Fix the library path
          install_name_tool -change "${LIBICONV_PATH}/lib/libiconv.dylib" \
            "@executable_path/../Frameworks/libiconv.dylib" \
            build/${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}
          
          echo "libiconv packaged successfully"
        else
          echo "Warning: libiconv not found at ${LIBICONV_PATH}/lib/libiconv.dylib"
        fi
    
    - name: Verify libiconv in bundle
      run: |
        echo "Checking if libiconv is properly packaged..."
        if [ -f "build/${{ env.APP_NAME }}.app/Contents/Frameworks/libiconv.dylib" ]; then
          echo "✓ libiconv.dylib found in bundle"
          otool -L "build/${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}" | grep libiconv || echo "libiconv not linked"
        else
          echo "✗ libiconv.dylib not found in bundle"
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: SubtitleEditApp-*-macOS.dmg
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: SubtitleEditApp-*-macOS.dmg
        token: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.*'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        cache: true
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Check Qt encoding support
      run: |
        # 创建测试程序检查编码支持
        cat > test_encodings.cpp << 'EOF'
        #include <QCoreApplication>
        #include <QStringConverter>
        #include <QDebug>
        #include <iostream>
        
        int main() {
            auto codecs = QStringConverter::availableCodecs();
            std::cout << "=== Available Codecs ===" << std::endl;
            bool hasGBK = false;
            bool hasSystem = false;
            
            for (const auto &codec : codecs) {
                std::cout << codec.toStdString() << std::endl;
                if (codec.contains("GBK", Qt::CaseInsensitive) || 
                    codec.contains("936", Qt::CaseInsensitive)) {
                    hasGBK = true;
                    std::cout << "*** GBK SUPPORT FOUND: " << codec.toStdString() << " ***" << std::endl;
                }
                if (codec.contains("System", Qt::CaseInsensitive)) {
                    hasSystem = true;
                    std::cout << "*** System SUPPORT FOUND: " << codec.toStdString() << " ***" << std::endl;
                }
            }
            
            std::cout << std::endl;
            std::cout << "GBK Support: " << (hasGBK ? "YES" : "NO") << std::endl;
            std::cout << "System Support: " << (hasSystem ? "YES" : "NO") << std::endl;
            
            return 0;
        }
        EOF
        
        # 编译并运行测试
        qmake -project "CONFIG += console"
        qmake CONFIG+=release
        nmake
        .\release\test_encodings.exe
    
    - name: Set Windows locale for GBK support
      run: |
        # 设置系统代码页为 GBK
        chcp 936
        echo "Setting locale for GBK support..."
        echo "LC_ALL=zh_CN.GBK" >> $env:GITHUB_ENV
        echo "LANG=zh_CN.GBK" >> $env:GITHUB_ENV
    
    - name: Build and package using local script
      run: |
        # 设置环境变量
        $env:LC_ALL = "zh_CN.GBK"
        $env:LANG = "zh_CN.GBK"
        
        # 构建和打包
        .\package_windows.bat
    
    - name: Upload portable artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable
        path: SubtitleEditApp-*-Windows-Portable.zip
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: SubtitleEditApp-*-Windows-Portable.zip
        token: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux (AppImage)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.*'
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        cache: true
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-icccm4 \
          libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 \
          libxcb-cursor0 libfuse2 file
    
    - name: Build
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_PREFIX_PATH=$Qt6_DIR
        cmake --build build --config Release
    
    - name: Install to AppDir
      run: cmake --install build --prefix AppDir/usr
    
    - name: Download linuxdeploy
      run: |
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
    
    - name: Create AppImage
      run: |
        export QMAKE=$Qt6_DIR/bin/qmake
        ./linuxdeploy-x86_64.AppImage --appdir AppDir \
          --plugin qt \
          --output appimage
        mv ${{ env.APP_NAME }}-*.AppImage ${{ env.APP_NAME }}-Linux.AppImage
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-appimage
        path: ${{ env.APP_NAME }}-Linux.AppImage
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.APP_NAME }}-Linux.AppImage
        token: ${{ secrets.GITHUB_TOKEN }}
