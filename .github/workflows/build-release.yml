name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # 触发条件：推送版本标签，如 v1.0.0
  workflow_dispatch:  # 允许手动触发

env:
  APP_NAME: SubtitleEditApp

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-13
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.*'
        host: 'mac'
        target: 'desktop'
        arch: 'clang_64'
        cache: true
    
    - name: Make package script executable
      run: chmod +x package_macos.sh
    
    - name: Build and package using local script
      run: ./package_macos.sh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: SubtitleEditApp-*-macOS.dmg
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: SubtitleEditApp-*-macOS.dmg
        token: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.*'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        cache: true
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Build and package using local script
      run: .\package_windows.bat
    
    - name: Upload portable artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable
        path: SubtitleEditApp-*-Windows-Portable.zip
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: SubtitleEditApp-*-Windows-Portable.zip
        token: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux (AppImage)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.*'
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        cache: true
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-icccm4 \
          libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 \
          libxcb-cursor0 libfuse2 file
    
    - name: Build
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_PREFIX_PATH=$Qt6_DIR
        cmake --build build --config Release
    
    - name: Install to AppDir
      run: cmake --install build --prefix AppDir/usr
    
    - name: Download linuxdeploy
      run: |
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
    
    - name: Create AppImage
      run: |
        export QMAKE=$Qt6_DIR/bin/qmake
        ./linuxdeploy-x86_64.AppImage --appdir AppDir \
          --plugin qt \
          --output appimage
        mv ${{ env.APP_NAME }}-*.AppImage ${{ env.APP_NAME }}-Linux.AppImage
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-appimage
        path: ${{ env.APP_NAME }}-Linux.AppImage
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.APP_NAME }}-Linux.AppImage
        token: ${{ secrets.GITHUB_TOKEN }}
