name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # 触发条件：推送版本标签，如 v1.0.0
  workflow_dispatch:  # 允许手动触发

env:
  APP_NAME: SubtitleEditApp

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-13
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache Qt
      uses: actions/cache@v4
      with:
        path: ~/Qt
        key: ${{ runner.os }}-qt-6.6-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-qt-6.6-
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.*'
        host: 'mac'
        target: 'desktop'
        arch: 'clang_64'
        cache: false
    
    - name: Install GNU libiconv for GBK support
      run: |
        brew install libiconv
        echo "LIBICONV_PATH=$(brew --prefix libiconv)" >> $GITHUB_ENV
    
    - name: Make package script executable
      run: chmod +x package_macos.sh
    
    - name: Build and package using local script
      run: |
        # Build and package
        ./package_macos.sh
        
        # Copy libiconv to app bundle for GBK support
        if [ -f "${LIBICONV_PATH}/lib/libiconv.dylib" ]; then
          echo "Copying libiconv to app bundle..."
          cp "${LIBICONV_PATH}/lib/libiconv.dylib" build/${{ env.APP_NAME }}.app/Contents/Frameworks/
          
          # Fix the library path
          install_name_tool -change "${LIBICONV_PATH}/lib/libiconv.dylib" \
            "@executable_path/../Frameworks/libiconv.dylib" \
            build/${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}
          
          echo "libiconv packaged successfully"
        else
          echo "Warning: libiconv not found at ${LIBICONV_PATH}/lib/libiconv.dylib"
        fi
    
    - name: Verify libiconv in bundle
      run: |
        echo "Checking if libiconv is properly packaged..."
        if [ -f "build/${{ env.APP_NAME }}.app/Contents/Frameworks/libiconv.dylib" ]; then
          echo "✓ libiconv.dylib found in bundle"
          otool -L "build/${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}" | grep libiconv || echo "libiconv not linked"
        else
          echo "✗ libiconv.dylib not found in bundle"
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: SubtitleEditApp-*-macOS.dmg
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: SubtitleEditApp-*-macOS.dmg
        token: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache Qt
      uses: actions/cache@v4
      with:
        path: ~/Qt
        key: ${{ runner.os }}-qt-6.6-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-qt-6.6-
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.*'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        cache: false
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Setup MSVC Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Set Windows locale for GBK support
      shell: cmd
      run: |
        rem 设置系统代码页为 GBK
        chcp 936
        echo Setting locale for GBK support...
        set LC_ALL=zh_CN.GBK
        set LANG=zh_CN.GBK
    
    - name: Build and package using local script
      shell: cmd
      run: |
        rem 设置环境变量
        set LC_ALL=zh_CN.GBK
        set LANG=zh_CN.GBK
        
        rem 构建和打包
        .\package_windows.bat
    
    - name: Upload portable artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable
        path: SubtitleEditApp-*-Windows-Portable.zip
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: SubtitleEditApp-*-Windows-Portable.zip
        token: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux (AppImage)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache Qt
      uses: actions/cache@v4
      with:
        path: ~/Qt
        key: ${{ runner.os }}-qt-6.6-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-qt-6.6-
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.*'
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        cache: false
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-icccm4 \
          libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 \
          libxcb-cursor0 libfuse2 file
    
    - name: Build
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_PREFIX_PATH=$Qt6_DIR \
          -DQt6_DIR=$Qt6_DIR
        cmake --build build --config Release
    
    - name: Install to AppDir
      run: cmake --install build --prefix AppDir/usr
    
    - name: Create desktop file and icon
      run: |
        # 创建 desktop 文件
        cat > com.subtitleeditapp.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=SubtitleEditApp
        Name[zh_CN]=SRT字幕编辑器
        Comment=A simple SRT subtitle editor
        Comment[zh_CN]=简单的SRT字幕编辑器
        Exec=SubtitleEditApp
        Icon=com.subtitleeditapp
        Categories=AudioVideo;Video;
        Terminal=false
        MimeType=application/x-subrip;text/x-srt;
        EOF
        
        # 创建简单的 SVG 图标
        cat > icon.svg << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <rect width="64" height="64" fill="#2196F3" rx="8"/>
          <text x="32" y="20" font-family="Arial, sans-serif" font-size="8" fill="white" text-anchor="middle">SRT</text>
          <rect x="8" y="28" width="48" height="4" fill="white" rx="2"/>
          <rect x="8" y="36" width="48" height="4" fill="white" rx="2"/>
          <rect x="8" y="44" width="48" height="4" fill="white" rx="2"/>
          <rect x="8" y="52" width="32" height="4" fill="white" rx="2"/>
        </svg>
        EOF
    
    - name: Copy desktop file and icon
      run: |
        # 创建所需目录
        mkdir -p AppDir/usr/share/applications/
        mkdir -p AppDir/usr/share/icons/hicolor/64x64/apps/
        
        # 复制 desktop 文件
        cp com.subtitleeditapp.desktop AppDir/usr/share/applications/
        
        # 复制图标
        cp icon.svg AppDir/usr/share/icons/hicolor/64x64/apps/com.subtitleeditapp.svg
        
        # 创建 AppDir 根目录的符号链接
        ln -sf usr/share/applications/com.subtitleeditapp.desktop AppDir/
        ln -sf usr/share/icons/hicolor/64x64/apps/com.subtitleeditapp.svg AppDir/
    
    - name: Download linuxdeploy
      run: |
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
    
    - name: Create AppImage
      run: |
        export QMAKE=$Qt6_DIR/bin/qmake
        ./linuxdeploy-x86_64.AppImage --appdir AppDir \
          --plugin qt \
          --output appimage
        mv ${{ env.APP_NAME }}-*.AppImage ${{ env.APP_NAME }}-Linux.AppImage
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-appimage
        path: ${{ env.APP_NAME }}-Linux.AppImage
    
    - name: Upload to release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.APP_NAME }}-Linux.AppImage
        token: ${{ secrets.GITHUB_TOKEN }}
